<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawler Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #3b82f6; /* blue-500 */
            --color-primary-hover: #2563eb; /* blue-600 */
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; } /* gray-900 */
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; } /* gray-700 */
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; } /* gray-600 */

        .glass-panel {
            background: rgba(31, 41, 55, 0.6); /* gray-800/60 */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(75, 85, 99, 0.5); /* gray-600/50 */
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <nav class="glass-panel p-4 sticky top-0 z-50 border-b border-gray-700/50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-spider text-primary text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wider">Crawler <span class="text-primary">Center</span></h1>
            </div>
            <a href="/admin/queues" target="_blank" class="text-gray-400 hover:text-white transition-colors duration-300 flex items-center gap-2 text-sm">
                <i class="fa-solid fa-chart-bar"></i>
                <span>Monitoring</span>
            </a>
        </div>
    </nav>

    <main class="container mx-auto p-4 md:p-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <aside class="lg:col-span-4 xl:col-span-3 space-y-6">
                <div class="glass-panel p-6 rounded-lg shadow-2xl">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-paper-plane text-primary"></i> Lancer un Scan
                    </h2>
                    <form id="scanForm" class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1" for="siteName">Nom du projet</label>
                            <input type="text" id="siteName" placeholder="Ex: Jobs en France" 
                                class="w-full bg-gray-900/50 border border-gray-600 rounded p-2 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1" for="siteUrl">URL Cible</label>
                            <input type="url" id="siteUrl" placeholder="https://..." required
                                class="w-full bg-gray-900/50 border border-gray-600 rounded p-2 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition">
                        </div>
                        <button type="submit" 
                            class="w-full bg-primary hover:bg-primary-hover text-white font-bold py-2.5 px-4 rounded-lg transition-all duration-300 flex justify-center items-center gap-2 shadow-lg hover:shadow-primary/30">
                            <i class="fa-solid fa-plus-circle"></i> Ajouter à la file
                        </button>
                    </form>
                    <div id="statusMsg" class="mt-4 text-center text-sm" aria-live="polite"></div>
                </div>

                <div class="glass-panel p-6 rounded-lg shadow-2xl">
                    <h2 class="text-lg font-semibold mb-4 text-gray-300">Statistiques</h2>
                     <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Résultats trouvés:</span>
                            <span class="font-bold text-green-400 text-lg" id="countTotal">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Dernier ajout:</span>
                            <span class="font-mono text-blue-400" id="lastScanTime">-</span>
                        </div>
                    </div>
                </div>
            </aside>

            <section class="lg:col-span-8 xl:col-span-9">
                <div class="glass-panel p-4 sm:p-6 rounded-lg shadow-2xl h-full">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-primary"></i> Résultats
                        </h2>
                        <div class="relative w-full sm:max-w-xs">
                             <input type="text" id="searchInput" placeholder="Filtrer les résultats..." class="w-full bg-gray-900/50 border border-gray-600 rounded-full py-2 pl-10 pr-4 focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary transition">
                             <i class="fa-solid fa-search text-gray-500 absolute left-4 top-1/2 -translate-y-1/2"></i>
                        </div>
                    </div>

                    <div id="resultsContainer" class="space-y-4 mt-6 h-[calc(100vh-250px)] overflow-y-auto pr-2">
                        <!-- Les cartes de résultats seront injectées ici -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        const API_URL = ''; 

        const scanForm = document.getElementById('scanForm');
        const statusMsg = document.getElementById('statusMsg');
        const searchInput = document.getElementById('searchInput');
        let allResults = [];

        // --- GESTION DES EVENEMENTS ---

        scanForm.addEventListener('submit', handleScanSubmit);
        searchInput.addEventListener('input', () => renderResults(allResults));
        
        // --- FONCTIONS PRINCIPALES ---
        
        async function handleScanSubmit(e) {
            e.preventDefault();
            const url = document.getElementById('siteUrl').value;
            const name = document.getElementById('siteName').value;
            const btn = e.target.querySelector('button');
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Traitement...';
            btn.disabled = true;

            try {
                const res = await fetch(`/api/scan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, name })
                });
                
                if (res.ok) {
                    showStatus("✅ Ajouté à la file d'attente !", "text-green-400");
                    scanForm.reset();
                } else {
                    const errorData = await res.json();
                    throw new Error(errorData.message || 'Erreur serveur');
                }
            } catch (err) {
                showStatus(`❌ ${err.message}`, "text-red-400");
            } finally {
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    hideStatus();
                }, 2500);
            }
        }

        async function fetchResults() {
            try {
                const res = await fetch(`/api/results`);
                let data = await res.json();
                
                data.sort((a, b) => new Date(b.extracted_at) - new Date(a.extracted_at));
                
                if (JSON.stringify(allResults) !== JSON.stringify(data)) {
                    allResults = data;
                    updateStats(allResults);
                    renderResults(allResults);
                }
            } catch (err) {
                console.error("Erreur de récupération des résultats:", err);
            }
        }

        function renderResults(data) {
            const container = document.getElementById('resultsContainer');
            const filterText = searchInput.value.toLowerCase();
            
            const filteredData = data.filter(item => {
                const searchableContent = JSON.stringify(item).toLowerCase();
                return searchableContent.includes(filterText);
            });
            
            container.innerHTML = '';

            if (filteredData.length === 0) {
                container.innerHTML = `<div class="text-center p-10 text-gray-500">
                                           <i class="fa-solid fa-ghost text-3xl mb-4"></i>
                                           <p>Aucun résultat à afficher.</p>
                                       </div>`;
                return;
            }

            filteredData.forEach(item => {
                const card = document.createElement('div');
                card.className = "job-card glass-panel p-4 rounded-lg border border-transparent hover:border-primary/50 transition-all duration-300";
                
                const title = item.title || 'Titre non disponible';
                const organization = item.organization || 'Organisation non spécifiée';
                const location = item.location || 'Lieu non spécifié';
                const description = item.description || '';
                const url = item.url;
                const email = item.email;

                card.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-3">
                        <div class="flex-grow">
                            <h3 class="font-bold text-md text-gray-100">${title}</h3>
                            <p class="text-sm text-gray-400 mt-1">${organization}</p>
                            <p class="text-xs text-gray-500 mt-2 flex items-center gap-2">
                                <i class="fa-solid fa-map-marker-alt"></i>
                                <span>${location}</span>
                            </p>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2 mt-2 sm:mt-0">
                            ${email ? `<a href="mailto:${email}" class="h-8 w-8 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600 rounded-full text-gray-300 transition" title="Contacter par email"><i class="fa-solid fa-envelope"></i></a>` : ''}
                            ${url ? `<a href="${url}" target="_blank" class="h-8 w-8 flex items-center justify-center bg-primary/20 hover:bg-primary/40 rounded-full text-primary transition" title="Voir l'offre"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>` : ''}
                        </div>
                    </div>
                    ${description ? `<p class="text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700/50">${description.substring(0, 150)}${description.length > 150 ? '...' : ''}</p>` : ''}
                    <div class="text-right text-xs text-gray-600 font-mono mt-3">
                        ${new Date(item.extracted_at).toLocaleString('fr-FR')}
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // --- FONCTIONS UTILITAIRES ---

        function updateStats(data) {
            document.getElementById('countTotal').textContent = data.length;
            if(data.length > 0) {
                const date = new Date(data[0].extracted_at);
                document.getElementById('lastScanTime').textContent = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }
        
        function showStatus(message, styleClass) {
            statusMsg.textContent = message;
            statusMsg.className = `mt-4 text-center text-sm ${styleClass} transition-opacity duration-300 opacity-100`;
        }

        function hideStatus() {
            statusMsg.className = statusMsg.className.replace('opacity-100', 'opacity-0');
        }

        // --- INITIALISATION ---
        fetchResults();
        setInterval(fetchResults, 5000); // Rafraîchissement plus rapide

    </script>
</body>
</html>